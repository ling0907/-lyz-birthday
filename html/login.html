<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Happy Birthday</title>
	<link rel="stylesheet" type="text/css" href="../css/styles.css">
</head>

<body>
	<div class="htmleaf-container" id="main-content">
		<div class="wrapper">
			<div class="container">
				<h1>生日快乐</h1>
				<form class="form">
					<input id="userName" name="userName" type="text" placeholder="xx" value="李宇哲">
					<input id="pwd" name="pwd" type="password" placeholder="密码">
					<button type="submit" id="login-button">进入</button>
				</form>
			</div>
			<ul class="bg-bubbles">
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
				<li></li>
			</ul>
		</div>
	</div>

	<script src="../js/jquery-2.1.1.min.js" type="text/javascript"></script>
	<script src="../js/jquery-1.8.4.min.js" type="text/javascript"></script>

	<!-- 统一音频 -->
	<audio id="bg-music" src="../music/1.mp3" loop autoplay></audio>

	<script>
		// 音频管理系统
		const AudioPlayer = {
			audio: null,
			currentTime: 0,
			isPlaying: false,
			
			init: function() {
				this.audio = document.getElementById('bg-music');
				this.loadAudioState();
				this.setupEventListeners();
			},
			
			loadAudioState: function() {
				const savedTime = localStorage.getItem('audioCurrentTime');
				const savedPlaying = localStorage.getItem('audioPlaying');
				
				if (savedTime) {
					this.currentTime = parseFloat(savedTime);
				}
				
			// 设置音频时间并尝试立即播放
			this.audio.currentTime = this.currentTime;
			if (localStorage.getItem('audioPlaying') === 'true') {
				this.attemptAutoPlay();
			}
			},
			
			play: function() {
				this.audio.play().then(() => {
					this.isPlaying = true;
					localStorage.setItem('audioPlaying', 'true');
				}).catch(err => {
					console.log('播放失败:', err);
				});
			},
			
			pause: function() {
				this.audio.pause();
				this.isPlaying = false;
				this.saveState();
			},
			
			saveState: function() {
				localStorage.setItem('audioCurrentTime', this.audio.currentTime.toString());
				localStorage.setItem('audioPlaying', this.isPlaying.toString());
			},
			
			setupEventListeners: function() {
				// 页面卸载时保存状态
				window.addEventListener('beforeunload', () => {
					this.saveState();
				});
				
				// 页面可见性变化时控制播放
				document.addEventListener('visibilitychange', () => {
					if (document.hidden) {
						this.pause();
					} else {
						this.play();
					}
				});
				
				// 定期保存播放进度
				setInterval(() => {
					if (this.isPlaying) {
						this.saveState();
					}
				}, 1000);
				
				// 尝试立即自动播放
				this.attemptAutoPlay();
			},
			
			attemptAutoPlay: function() {
				// 多种方式尝试自动播放
				const playPromise = this.audio.play();
				
				if (playPromise !== undefined) {
					playPromise.then(() => {
						this.isPlaying = true;
						localStorage.setItem('audioPlaying', 'true');
						console.log('音频自动播放成功');
					}).catch(err => {
						console.log('自动播放失败，等待用户交互:', err);
						// 如果失败，监听任意用户交互后播放
						document.addEventListener('click', () => this.play(), { once: true });
						document.addEventListener('keydown', () => this.play(), { once: true });
						document.addEventListener('mousemove', () => this.play(), { once: true });
						document.addEventListener('scroll', () => this.play(), { once: true });
					});
				}
			}
		};

		$(document).ready(function() {
			// 初始化音频
			AudioPlayer.init();
			
			// 直接显示主要内容，播放音乐
			setTimeout(() => {
				AudioPlayer.attemptAutoPlay();
			}, 500);
			
			// 页面加载完成后立即尝试自动播放
			setTimeout(() => {
				AudioPlayer.attemptAutoPlay();
			}, 500);
		});
	</script>

</body>

</html>